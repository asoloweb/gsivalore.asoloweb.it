---
import { DIRECTUS_URL } from '../lib/directus';

interface PageRef {
	id?: number;
	slug?: string;
}

interface SingleCard {
	id?: number;
	titolo_card?: string;
	immagine?: string;
	href?: string;
	link?: PageRef | number | null;
}

interface CardRelation {
	single_card_id?: SingleCard | number | null;
}

interface Props {
	titolo?: string;
	card?: CardRelation[] | SingleCard[];
}

const { titolo = '', card = [] } = Astro.props;

function resolveImageSrc(value: string | undefined) {
	if (!value) return '';
	if (value.startsWith('http://') || value.startsWith('https://') || value.startsWith('/')) {
		return value;
	}
	return `${DIRECTUS_URL}/assets/${value}`;
}

function normalizeCards(input: CardRelation[] | SingleCard[]) {
	if (!Array.isArray(input)) return [];
	return input
		.map((entry) => {
			if (!entry || typeof entry !== 'object') return null;
			if ('single_card_id' in entry) {
				return entry.single_card_id && typeof entry.single_card_id === 'object'
					? (entry.single_card_id as SingleCard)
					: null;
			}
			if ('titolo_card' in entry || 'immagine' in entry || 'href' in entry) {
				return entry as SingleCard;
			}
			return null;
		})
		.filter((entry): entry is SingleCard => Boolean(entry));
}

function getCardHref(card: SingleCard) {
	if (card.href) return card.href;
	if (card.link && typeof card.link === 'object' && card.link.slug) {
		return card.link.slug === 'home' ? '/' : `/${card.link.slug}`;
	}
	return '';
}

const cards = normalizeCards(card);
---

{cards.length > 0 && (
	<section class="cards_block" data-aos="fade-up" data-aos-duration="1500">
		<div class="cards_block_inner">
			{titolo && <h2 class="cards_block_title">{titolo}</h2>}

			<div class="cards_grid">
				{cards.map((single) => {
					const href = getCardHref(single);
					const Tag = href ? 'a' : 'div';
					const imageSrc = resolveImageSrc(single.immagine);

					return (
						<Tag class="cards_card" href={href || undefined}>
							{imageSrc && (
								<div class="cards_card_media">
									<img src={imageSrc} alt={single.titolo_card || ''} loading="lazy" />
								</div>
							)}
							{single.titolo_card && <h3 class="cards_card_title">{single.titolo_card}</h3>}
						</Tag>
					);
				})}
			</div>
		</div>
	</section>
)}

<style>
	.cards_block {
		padding: 40px 20px 20px;
	}

	.cards_block_inner {
		max-width: var(--max-width);
		margin: 0 auto;
	}

	.cards_block_title {
		margin: 0 0 24px;
		color: var(--bianco);
		font-size: clamp(28px, 4vw, 42px);
	}

	.cards_grid {
		display: grid;
		grid-template-columns: repeat(3, minmax(0, 1fr));
		gap: 24px;
	}

	.cards_card {
		display: flex;
		flex-direction: column;
		gap: 12px;
		padding: 18px;
		background: var(--bianco);
		border-radius: 18px;
		color: var(--nero);
		transition: transform 200ms ease, box-shadow 200ms ease;
		min-height: 100%;
	}

	a.cards_card:hover {
		transform: translateY(-4px);
		box-shadow: 0 16px 30px rgba(0, 0, 0, 0.15);
	}

	.cards_card_media {
		overflow: hidden;
		border-radius: 12px;
		aspect-ratio: 4 / 3;
		background: var(--grigio-chiaro);
	}

	.cards_card_media img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.cards_card_title {
		margin: 4px 0 0;
		font-size: 20px;
		line-height: 1.3;
	}

	@media (max-width: 1024px) {
		.cards_grid {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
	}

	@media (max-width: 640px) {
		.cards_grid {
			grid-template-columns: 1fr;
		}
	}
</style>

