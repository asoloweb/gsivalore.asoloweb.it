---
import { DIRECTUS_URL, directusItemsUrl } from '../lib/directus';

interface MenuItem {
	id?: number | string;
	label?: string;
	custom_href?: string;
	pages?: { pages_id?: PageItem | number | string }[] | PageItem[];
}

interface Menu {
	id: number;
	slug?: string;
	titolo?: string;
	menu_items?: MenuItem[] | (number | string)[];
}

interface PageItem {
	id?: number;
	slug?: string;
	title?: string;
}

interface Options {
	logo_light?: string;
	footer_text?: string;
}

let logoLightSrc = import.meta.env.PUBLIC_LOGO_LIGHT || '/favicon.svg';
let footerText = '';
const footerMenus = [
	{ slug: 'menu-footer-1', items: [] as MenuItem[] },
	{ slug: 'menu-footer-2', items: [] as MenuItem[] },
	{ slug: 'menu-footer-3', items: [] as MenuItem[] },
];

try {
	const optionsUrl = directusItemsUrl('options');
	optionsUrl.searchParams.set('fields', 'logo_light,footer_text');
	const optionsResponse = await fetch(optionsUrl);
	if (optionsResponse.ok) {
		const optionsPayload = await optionsResponse.json();
		const options =
			optionsPayload?.data && Array.isArray(optionsPayload.data)
				? optionsPayload.data[0]
				: optionsPayload?.data;
		if (options?.logo_light) {
			logoLightSrc = resolveImageSrc(options.logo_light);
		}
		if (options?.footer_text) {
			footerText = options.footer_text;
		}
	}

	const menuFields =
		'menu_items.menu_items_id.id,menu_items.menu_items_id.label,menu_items.menu_items_id.custom_href,menu_items.menu_items_id.pages.pages_id.id,menu_items.menu_items_id.pages.pages_id.slug,menu_items.menu_items_id.pages.pages_id.title';

	for (const footerMenu of footerMenus) {
		const url = directusItemsUrl('Menus');
		url.searchParams.set('filter[slug][_eq]', footerMenu.slug);
		url.searchParams.set('fields', menuFields);
		const response = await fetch(url);
		if (!response.ok) {
			throw new Error(`HTTP ${response.status}: ${response.statusText}`);
		}
		const data = await response.json();
		const menu: Menu | undefined = (data.data || [])[0];
		const rawItems = Array.isArray(menu?.menu_items) ? menu.menu_items : [];
		const itemObjects = rawItems
			.map((item) => {
				if (!item || typeof item !== 'object') return null;
				if ('menu_items_id' in item && item.menu_items_id && typeof item.menu_items_id === 'object') {
					return item.menu_items_id as MenuItem;
				}
				return item as MenuItem;
			})
			.filter((item): item is MenuItem => Boolean(item));

		footerMenu.items = itemObjects;
	}
} catch (error) {
	console.error('Error fetching footer menu from Directus:', error);
}

function resolveImageSrc(value: string) {
	if (!value) return '';
	if (value.startsWith('http://') || value.startsWith('https://') || value.startsWith('/')) {
		return value;
	}
	return `${DIRECTUS_URL}/assets/${value}`;
}

function getItemPage(item: MenuItem): PageItem | null {
	const rawPages = item.pages;
	if (!rawPages || !Array.isArray(rawPages)) return null;
	const normalizedPages = rawPages
		.map((page) => {
			if (!page) return null;
			if (typeof page === 'object' && 'pages_id' in page) {
				return page.pages_id && typeof page.pages_id === 'object'
					? (page.pages_id as PageItem)
					: null;
			}
			if (typeof page === 'object' && 'slug' in page) {
				return page as PageItem;
			}
			return null;
		})
		.filter((page): page is PageItem => Boolean(page));

	return normalizedPages[0] ?? null;
}

function getItemHref(item: MenuItem) {
	if (item.custom_href) return item.custom_href;
	const page = getItemPage(item);
	if (!page?.slug || page.slug === 'home') return '/';
	return `/${page.slug}`;
}

function getItemTitle(item: MenuItem, index: number) {
	return item.label || getItemPage(item)?.title || `Link ${index + 1}`;
}
---

<footer class="site-footer">
	<nav aria-label="Menu footer">
		<div>
			<a href="/">
				<img class="MenuLogo" src={logoLightSrc} alt="Logo" />
			</a>
		</div>
		<div class="FooterItemsContainer">
			{footerMenus.map((footerMenu) => (
				<div class="FooterMenuColumn">
					{footerMenu.items.map((item, index) => {
						const href = getItemHref(item);
						const title = getItemTitle(item, index);
						return (
							<a href={href} class="menu_item">
								{title}
							</a>
						);
					})}
				</div>
			))}
		</div>
	</nav>
	<div class="footer_data" set:html={footerText} />
</footer>
