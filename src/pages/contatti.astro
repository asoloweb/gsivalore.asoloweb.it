---
import BaseLayout from '../layouts/BaseLayout.astro';
import PageContent from '../components/PageContent.astro';
import ContactForm from '../components/ContactForm.astro';
import { DIRECTUS_URL, directusItemsUrl } from '../lib/directus';

type Page = {
	status?: string;
	slug?: string;
	title?: string;
	Titolo?: string;
	seo_title?: string;
	seo_desc?: string;
	description?: string;
	hide_page_header?: boolean;
	page_header?: string;
	featured_image?: string;
	editor?: unknown[];
};

async function fetchContactsPage() {
	const url = directusItemsUrl('pages');
	url.searchParams.set(
		'fields',
		'*,slug.*,editor.item.*,editor.item.slider.*,editor.item.slider.slides.item.*,editor.item.card.single_card_id.*,editor.item.card.single_card_id.link.id,editor.item.card.single_card_id.link.slug,editor.item.card.single_card_id.link.title'
	);
	url.searchParams.set('filter[status][_eq]', 'published');
	url.searchParams.set('filter[slug][_eq]', 'contatti');

	const response = await fetch(url);
	const data = await response.json();
	return (data?.data?.[0] as Page | undefined) ?? null;
}

const page: Page | null = await fetchContactsPage();
const pageTitle = page?.title || page?.Titolo || '';
const pageDescription = page?.description || '';

function resolveImageSrc(value: string) {
	if (!value) return '';
	if (value.startsWith('http://') || value.startsWith('https://') || value.startsWith('/')) {
		return value;
	}
	return `${DIRECTUS_URL}/assets/${value}`;
}

const pageHeaderImage = page?.featured_image ? resolveImageSrc(page.featured_image) : '';
const showPageHeader = page ? !page.hide_page_header : false;
---

<BaseLayout
	title={page?.title || page?.Titolo || 'Contatti'}
	seoTitle={page?.seo_title}
	seoDescription={page?.seo_desc}
>
	{showPageHeader && (
		<div
			class="page_header"
			style={pageHeaderImage ? `background-image: url('${pageHeaderImage}')` : undefined}
		>
			<div class="page_header_inner">
				{pageTitle && <h1 data-aos="fade-up" data-aos-duration="1500">{pageTitle}</h1>}
				{pageDescription && <p data-aos="fade-up" data-aos-duration="1800">{pageDescription}</p>}
			</div>
		</div>
	)}

	<div class="contatti_layout">
		<div class="contatti_column contatti_content">
			<PageContent
				page={page}
				showHeader={false}
				notFoundTitle="Pagina contatti non trovata"
				notFoundMessage="La pagina contatti richiesta non esiste."
			/>
		</div>
		<div class="contatti_column contatti_form">
			<ContactForm />
		</div>
	</div>
</BaseLayout>

<style>
	.contatti_layout {
		max-width: var(--max-width);
		margin: 10px auto 80px;
		padding: 0 20px;
		display: grid;
		grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
		gap: 28px;
		align-items: start;
	}

	.contatti_column {
		min-width: 0;
	}

	@media (max-width: 980px) {
		.contatti_layout {
			grid-template-columns: 1fr;
		}
	}
</style>
